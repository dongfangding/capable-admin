<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ddf.boot.capableadmin.infra.mapper.SysRoleMapper">
    <resultMap id="UserRoleMenuMap" type="com.ddf.boot.capableadmin.model.dto.UserRoleMenuDTO">
        <id column="role_id" property="roleId"/>
        <result column="role_name" property="name"/>
        <result column="role_level" property="level"/>
        <result column="role_description" property="description"/>
        <collection property="menuList" ofType="com.ddf.boot.capableadmin.model.dto.SimpleMenu">
            <id column="menu_id" property="menuId"/>
            <result column="menu_title" property="title"/>
            <result column="menu_permission" property="permission"/>
        </collection>
    </resultMap>


    <select id="findByUserId" resultMap="UserRoleMenuMap">
        SELECT ur.role_id       AS role_id,
               role.name        AS role_name,
               role.level       AS role_level,
               role.description AS role_description,
               menu.menu_id     AS menu_id,
               menu.title       AS menu_title,
               menu.permission  AS menu_permission
        from sys_role role
                 left join sys_role_menu srm on role.role_id = srm.role_id
                 left join sys_menu menu on menu.menu_id = srm.menu_id
                 left join sys_user_role ur on role.role_id = ur.role_id
        WHERE role.role_id = ur.role_id
          AND ur.user_id = #{userId}
    </select>

    <select id="getUserAllRoleIds" resultType="java.lang.Long">
        SELECT ur.role_id
        from sys_role role
                 left join sys_role_menu srm on role.role_id = srm.role_id
                 left join sys_menu menu on menu.menu_id = srm.menu_id
                 left join sys_user_role ur on role.role_id = ur.role_id
        WHERE role.role_id = ur.role_id
          AND ur.user_id = #{userId}
          and menu.hidden = 0
    </select>

    <select id="listAll" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from sys_role
        order by sort, role_id desc
    </select>

    <select id="findByRoleName" resultMap="BaseResultMap">
        select *
        from sys_role
        where name = #{name}
        limit 1
    </select>

    <delete id="deleteByRoleIds">
        delete
        from sys_role where role_id in
        <foreach collection="roleIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <!-- 根据菜单ID查询关联的角色ID列表 -->
    <select id="findRoleIdsByMenuId" resultType="java.lang.Long">
        SELECT DISTINCT sr.role_id
        FROM sys_role sr
                 INNER JOIN sys_role_menu srm ON sr.role_id = srm.role_id
        WHERE srm.menu_id = #{menuId,jdbcType=BIGINT}
    </select>

    <!-- 查询用户的所有角色名称 -->
    <select id="findRoleNamesByUserId" resultType="java.lang.String">
        SELECT DISTINCT sr.name
        FROM sys_role sr
                 INNER JOIN sys_user_role ur ON sr.role_id = ur.role_id
        WHERE ur.user_id = #{userId,jdbcType=BIGINT}
    </select>
</mapper>
